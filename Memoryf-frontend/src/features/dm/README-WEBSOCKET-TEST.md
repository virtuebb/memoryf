# ğŸ§ª WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ (Chat.jsx)

## ğŸ“Œ ê°œìš”

`Chat.jsx`ëŠ” **WebSocket ì‹¤ì‹œê°„ ì±„íŒ…ì„ í…ŒìŠ¤íŠ¸**í•˜ê¸° ìœ„í•œ ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
ì‹¤ì œ DM ê¸°ëŠ¥ì— WebSocketì„ í†µí•©í•˜ê¸° ì „ì—, ë°±ì—”ë“œì™€ì˜ ì—°ê²°ì„ í™•ì¸í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

---

## ğŸŒ WebSocketì´ë€?

### HTTP vs WebSocket

```
ğŸ“¡ HTTP (ì¼ë°˜ ìš”ì²­)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
í´ë¼ì´ì–¸íŠ¸ â”€â”€ìš”ì²­â”€â”€â–¶ ì„œë²„
í´ë¼ì´ì–¸íŠ¸ â—€â”€â”€ì‘ë‹µâ”€â”€ ì„œë²„
(í•œ ë²ˆ ì£¼ê³ ë°›ê³  ì—°ê²° ëŠê¹€)

ğŸ”Œ WebSocket (ì‹¤ì‹œê°„ ì–‘ë°©í–¥)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
í´ë¼ì´ì–¸íŠ¸ â—€â•â•â•â•â•â•â•â–¶ ì„œë²„
(ì—°ê²° ìœ ì§€, ì–‘ìª½ì—ì„œ ì–¸ì œë“  ë©”ì‹œì§€ ì „ì†¡ ê°€ëŠ¥)
```

| íŠ¹ì§• | HTTP | WebSocket |
|------|------|-----------|
| ì—°ê²° | ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œ ì—°ê²° | í•œ ë²ˆ ì—°ê²° í›„ ìœ ì§€ |
| ë°©í–¥ | í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ | ì–‘ë°©í–¥ |
| ì‹¤ì‹œê°„ | âŒ (í´ë§ í•„ìš”) | âœ… |
| ìš©ë„ | REST API | ì±„íŒ…, ì•Œë¦¼, ê²Œì„ |

---

## ğŸ—ï¸ ê¸°ìˆ  ìŠ¤íƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     í”„ë¡ íŠ¸ì—”ë“œ                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Chat.jsx   â”‚â”€â”€â”€â”€â–¶â”‚  @stomp/stompjs (v7)        â”‚    â”‚
â”‚  â”‚  (React)    â”‚     â”‚  + SockJS                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                         WebSocket ì—°ê²°â”‚(http://localhost:8006/memoryf/ws)
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ë°±ì—”ë“œ                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              WebSocketConfig.java                â”‚    â”‚
â”‚  â”‚  - ì—”ë“œí¬ì¸íŠ¸: /ws (context-pathë¡œ /memoryf/ws)  â”‚    â”‚
â”‚  â”‚  - CORS: setAllowedOriginPatterns("*")          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              DmController.java                   â”‚    â”‚
â”‚  â”‚  - @MessageMapping("/chat/private")             â”‚    â”‚
â”‚  â”‚  - ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ëŒ€ìƒì—ê²Œ ì „ë‹¬                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì‚¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬

| ë¼ì´ë¸ŒëŸ¬ë¦¬ | ë²„ì „ | ì—­í•  |
|-----------|------|------|
| `@stomp/stompjs` | v7 | STOMP í”„ë¡œí† ì½œ í´ë¼ì´ì–¸íŠ¸ |
| `sockjs-client` | v1.6 | WebSocket í´ë°± (IE ì§€ì›) |

stomp : ì›¹ì†Œì¼“ì„ í†µí•´ ë©”ì„¸ì§€ë¥¼ ì–´ë–»ê²Œ ë³´ë‚´ê±´ì§€ ì–´ë–»ê²Œ ë°›ì„ ê±´ì§€ ì •ì˜ í•œ ê·œì¹™ì˜ í•œ ì¢…ë¥˜
ì„¸ ê°€ì§€ ê°œë…ì´ ì¡´ì¬
1. SEND : íŠ¹ì • destinationìœ¼ë¡œ ë©”ì„¸ì§€ë¥¼ ë³´ëƒ„
2. subcribe : íŠ¹ì • destinationìœ¼ë¡œ ì˜¤ëŠ” ëª¨ë“  ë©”ì„¸ì§€ë¥¼ ë°›ìŒ
3. destination
| ëª©ì         | ì˜ˆì‹œ                   |
| --------- | -------------------- |
| ì„œë²„ë¡œ ë³´ëƒ„    | `/pub/chat/private`  |
| í´ë¼ì´ì–¸íŠ¸ë¡œ ë°›ìŒ | `/sub/private/user2` |

ê¸°ì¤€ ì•½ì†ì´ ì¡´ì¬
| êµ¬ë¶„        | ì˜ë¯¸         |
| --------- | ---------- |
| `/pub/**` | í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ |
| `/sub/**` | ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸ |


---

## ğŸ”„ ë©”ì‹œì§€ íë¦„

### 1:1 ì±„íŒ… ì‹œë‚˜ë¦¬ì˜¤

```
User1 (sender)                   ì„œë²„                    User2 (receiver)
     â”‚                            â”‚                            â”‚
     â”‚ 1. ì—°ê²°                     â”‚                            â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
     â”‚ êµ¬ë…: /sub/private/user1   â”‚                            â”‚
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚      2. ì—°ê²°                â”‚
     â”‚                            â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                            â”‚      êµ¬ë…: /sub/private/user2
     â”‚                            â”‚                            â”‚
     â”‚ 3. ë©”ì‹œì§€ ì „ì†¡              â”‚                            â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
     â”‚ dest: /pub/chat/private    â”‚                            â”‚
     â”‚ body: {                    â”‚                            â”‚
     â”‚   roomId: "user2",         â”‚                            â”‚
     â”‚   sender: "user1",         â”‚ 4. ë©”ì‹œì§€ ì „ë‹¬              â”‚
     â”‚   content: "ì•ˆë…•!"         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚
     â”‚ }                          â”‚ /sub/private/user2         â”‚
     â”‚                            â”‚                            â”‚
```

### STOMP ê²½ë¡œ ì •ë¦¬

| ê²½ë¡œ | ë°©í–¥ | ì„¤ëª… |
|------|------|------|
| `/memoryf/ws` | ì—°ê²° | WebSocket ì—”ë“œí¬ì¸íŠ¸ (SockJS) |
| `/pub/chat/private` | í´ë¼ì´ì–¸íŠ¸â†’ì„œë²„ | ë©”ì‹œì§€ ë°œí–‰ |
| `/sub/private/{userId}` | ì„œë²„â†’í´ë¼ì´ì–¸íŠ¸ | ë©”ì‹œì§€ êµ¬ë… |

---

## ğŸ“ ì½”ë“œ ì„¤ëª…

### 1. ì—°ê²° ì„¤ì •

```javascript
import { Client } from '@stomp/stompjs';
import SockJS from 'sockjs-client';

const stompClient = new Client({
  // SockJSë¥¼ ì‚¬ìš©í•œ WebSocket íŒ©í† ë¦¬
  webSocketFactory: () => new SockJS('http://localhost:8006/memoryf/ws'),
  
  // ì—°ê²° ì„±ê³µ ì‹œ ì½œë°±
  onConnect: () => {
    console.log('ì—°ê²° ì„±ê³µ!');
    
    // ë‚´ê²Œ ì˜¤ëŠ” ë©”ì‹œì§€ êµ¬ë…
    stompClient.subscribe('/sub/private/user1', (msg) => {
      const data = JSON.parse(msg.body);
      console.log('ë°›ì€ ë©”ì‹œì§€:', data);
    });
  },
  
  // ì—ëŸ¬ ì²˜ë¦¬
  onStompError: (frame) => console.error('STOMP ì—ëŸ¬'),
  onWebSocketError: (event) => console.error('WebSocket ì—ëŸ¬'),
});

// ì—°ê²° ì‹œì‘
stompClient.activate();
```

### 2. ë©”ì‹œì§€ ì „ì†¡

```javascript
stompClient.publish({
  destination: '/pub/chat/private',  // ì„œë²„ë¡œ ë³´ë‚´ëŠ” ê²½ë¡œ
  body: JSON.stringify({
    roomId: 'user2',      // ë°›ëŠ” ì‚¬ëŒ ID
    sender: 'user1',      // ë³´ë‚´ëŠ” ì‚¬ëŒ ID  
    content: 'ì•ˆë…•í•˜ì„¸ìš”!' // ë©”ì‹œì§€ ë‚´ìš©
  })
});
```

### 3. ì—°ê²° í•´ì œ

```javascript
stompClient.deactivate();  // v7ì—ì„œëŠ” deactivate() ì‚¬ìš©
```

---

## ğŸš€ í…ŒìŠ¤íŠ¸ ë°©ë²•

### ì‚¬ì „ ì¤€ë¹„

1. **ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜**
   ```bash
   npm install sockjs-client @stomp/stompjs
   ```

2. **vite.config.js ì„¤ì •** (global í´ë¦¬í•„)
   ```javascript
   export default defineConfig({
     define: {
       global: 'globalThis',  // sockjs-client í˜¸í™˜ì„±
     },
   });
   ```

### í…ŒìŠ¤íŠ¸ ìˆœì„œ

1. **ë°±ì—”ë“œ ì‹¤í–‰** (Spring Boot - `localhost:8006`)

2. **í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰** (`npm run dev` - `localhost:5173`)

3. **í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì ‘ì†**
   ```
   http://localhost:5173/chat-test
   ```

4. **ë‘ ê°œì˜ ë¸Œë¼ìš°ì € íƒ­**ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
   
   | íƒ­ 1 | íƒ­ 2 |
   |------|------|
   | ID: `user1` | ID: `user2` |
   | ë°›ëŠ” ì‚¬ëŒ: `user2` | ë°›ëŠ” ì‚¬ëŒ: `user1` |
   | ì—°ê²° í´ë¦­ | ì—°ê²° í´ë¦­ |
   | ë©”ì‹œì§€ ì „ì†¡ | ë©”ì‹œì§€ ìˆ˜ì‹ ! |

---

## ğŸ”§ ë¬¸ì œ í•´ê²°

### 1. "global is not defined" ì—ëŸ¬

**ì›ì¸**: sockjs-clientê°€ Node.jsì˜ `global` ê°ì²´ ì‚¬ìš©

**í•´ê²°**: vite.config.jsì— ì¶”ê°€
```javascript
define: {
  global: 'globalThis',
}
```

### 2. CORS ì—ëŸ¬

**ì›ì¸**: í”„ë¡ íŠ¸(5173)ì™€ ë°±ì—”ë“œ(8006) ë„ë©”ì¸ì´ ë‹¤ë¦„

**í•´ê²°**: ë°±ì—”ë“œ WebSocketConfig.java í™•ì¸
```java
registry.addEndpoint("/ws")
        .setAllowedOriginPatterns("*")  // ëª¨ë“  origin í—ˆìš©
        .withSockJS();
```

### 3. ì—°ê²° ì‹¤íŒ¨

**í™•ì¸ ì‚¬í•­**:
- ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰ ì¤‘ì¸ì§€
- í¬íŠ¸ ë²ˆí˜¸ (8006) ë§ëŠ”ì§€
- context-path (`/memoryf`) í¬í•¨í–ˆëŠ”ì§€

### 4. ë©”ì‹œì§€ê°€ ì•ˆ ì˜´

**í™•ì¸ ì‚¬í•­**:
- êµ¬ë… ê²½ë¡œ: `/sub/private/{ë‚´ID}` (ë‚´ IDë¡œ êµ¬ë…í•´ì•¼ í•¨)
- ë°œí–‰ ê²½ë¡œ: `/pub/chat/private`
- roomId: ë°›ëŠ” ì‚¬ëŒ ID

---

## ğŸ“Š ë°±ì—”ë“œ ì½”ë“œ ì°¸ê³ 

### WebSocketConfig.java
```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {
    
    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws")
                .setAllowedOriginPatterns("*")
                .withSockJS();
    }
    
    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.setApplicationDestinationPrefixes("/pub");  // í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„
        registry.enableSimpleBroker("/sub", "/queue");       // ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸
    }
}
```

### DmController.java
```java
@RestController
public class DmController {
    
    @Autowired
    private SimpMessagingTemplate messagingTemplate;
    
    @MessageMapping("/chat/private")
    public void privateChat(Dm message) {
        // ë°›ëŠ” ì‚¬ëŒì˜ êµ¬ë… ì±„ë„ë¡œ ë©”ì‹œì§€ ì „ì†¡
        messagingTemplate.convertAndSend(
            "/sub/private/" + message.getRoomId(),
            message
        );
    }
}
```

---

## ğŸ”— ì‹¤ì œ DM ê¸°ëŠ¥ì— í†µí•©í•˜ë ¤ë©´

í˜„ì¬ DM ê¸°ëŠ¥ì€ ë”ë¯¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
WebSocketì„ í†µí•©í•˜ë ¤ë©´ `DmContext.jsx`ì—ì„œ:

1. **ì—°ê²° ê´€ë¦¬**: ë¡œê·¸ì¸ ì‹œ WebSocket ì—°ê²°
2. **êµ¬ë…**: ë‚´ IDë¡œ ë©”ì‹œì§€ êµ¬ë…
3. **ë©”ì‹œì§€ ìˆ˜ì‹ **: ì‹¤ì‹œê°„ìœ¼ë¡œ chatRooms ì—…ë°ì´íŠ¸
4. **ë©”ì‹œì§€ ì „ì†¡**: handleSendMessageì—ì„œ WebSocket ì‚¬ìš©

```javascript
// DmContext.jsxì— ì¶”ê°€í•  ì˜ˆì‹œ
useEffect(() => {
  if (ë¡œê·¸ì¸ëœ_ì‚¬ìš©ì) {
    const client = new Client({
      webSocketFactory: () => new SockJS(WS_URL),
      onConnect: () => {
        client.subscribe(`/sub/private/${userId}`, (msg) => {
          // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ chatRooms ì—…ë°ì´íŠ¸
          const data = JSON.parse(msg.body);
          setChatRooms(prev => /* ì—…ë°ì´íŠ¸ ë¡œì§ */);
        });
      }
    });
    client.activate();
    
    return () => client.deactivate();
  }
}, [userId]);
```

