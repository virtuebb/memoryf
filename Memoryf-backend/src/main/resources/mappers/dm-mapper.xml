<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dmMapper">
	
	<resultMap id="dmResultSet" type="dmRoom">
		<id column="ROOM_NO" property="roomNo" />
		<result column="CREATE_DATE" property="createDate" />
		<result column="ROOM_NAME" property="roomName" />
		<!-- selectDmRoomList용 필드들 -->
		<result column="TARGET_USER_ID" property="targetUserId" />
		<result column="TARGET_USER_NAME" property="targetUserName" />
		<result column="LAST_MESSAGE" property="lastMessage" />
		<result column="LAST_SEND_DATE" property="lastSendDate" />
		<result column="UNREAD_COUNT" property="unreadCount" />
		<result column="AVATAR" property="avatar" />
	</resultMap>

	<!-- 메세지 ResultSet -->
	<resultMap id="dmMessageResultSet" type="dmMessage">
		<id column="MESSAGE_NO" property="messageNo" />
		<result column="ROOM_NO" property="roomNo" />
		<result column="SENDER_ID" property="senderId" />
		<result column="CONTENT" property="content" />
		<result column="CREATE_DATE" property="createDate" />
		<!-- 읽음 여부 (0: 읽음, 1: 안읽음) -->
		<result column="READ_CHECK" property="readCheck" />
	</resultMap>
	
	<!-- Dm 방 조회용 쿼리 (채팅 목록) -->
	<select id="selectDmRoomList" parameterType="string" resultMap="dmResultSet">
		SELECT 
		    r.ROOM_NO,
		    p2.MEMBER_ID AS TARGET_USER_ID,
		    m.MEMBER_NAME AS TARGET_USER_NAME,
		    COALESCE(
		        (SELECT CONTENT FROM TB_DM_MESSAGE 
		         WHERE ROOM_NO = r.ROOM_NO AND IS_DEL = 'N' 
		         ORDER BY MESSAGE_NO DESC 
		         FETCH FIRST 1 ROW ONLY),
		        '대화 없음'
		    ) AS LAST_MESSAGE,
		    COALESCE(
		        (SELECT TO_CHAR(CREATE_DATE + (9/24), 'YYYY-MM-DD HH24:MI:SS') FROM TB_DM_MESSAGE 
		         WHERE ROOM_NO = r.ROOM_NO AND IS_DEL = 'N' 
		         ORDER BY MESSAGE_NO DESC 
		         FETCH FIRST 1 ROW ONLY),
		        TO_CHAR(r.CREATE_DATE + (9/24), 'YYYY-MM-DD HH24:MI:SS')
		    ) AS LAST_SEND_DATE,
		    COALESCE(
		        (SELECT COUNT(*) FROM TB_DM_MESSAGE 
		         WHERE ROOM_NO = r.ROOM_NO 
		           AND SENDER_ID = p2.MEMBER_ID
		           AND MESSAGE_NO > NVL(p1.LAST_READ_MESSAGE_NO, 0)
		           AND IS_DEL = 'N'),
		        0
		    ) AS UNREAD_COUNT
		FROM TB_DM_ROOM r
		JOIN TB_DM_PARTICIPANT p1 ON r.ROOM_NO = p1.ROOM_NO
		JOIN TB_DM_PARTICIPANT p2 ON r.ROOM_NO = p2.ROOM_NO 
		JOIN TB_MEMBER m ON m.MEMBER_ID = p2.MEMBER_ID
		WHERE p1.MEMBER_ID = #{userId}
		  AND p2.MEMBER_ID != p1.MEMBER_ID
		ORDER BY LAST_SEND_DATE DESC
	</select>

	<!-- 참여자 존재 여부 확인 쿼리 -->
    <select id="checkParticipantExists" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM TB_DM_PARTICIPANT 
        WHERE ROOM_NO = #{roomNo} AND MEMBER_ID = #{memberId}
    </select>

	<!-- 새로운 DM 방 생성용 쿼리 -->
	<!-- selectKey로 시퀀스 값을 먼저 가져와 parameter의 roomNo에 설정하고 그걸 반환할 수 있음-->
	<insert id="insertRoom" parameterType="map" useGeneratedKeys="false">
		<selectKey keyProperty="roomNo" order="BEFORE" resultType="int">
			SELECT SEQ_DM_ROOM_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_DM_ROOM(
					  ROOM_NO)
		       VALUES(
					  #{roomNo})
	</insert>

	<!-- 새로운 방에 참여자(발신자) 정보 삽입용 쿼리 -->
	<insert id="insertParticipantSender" parameterType="map">
		INSERT INTO TB_DM_PARTICIPANT (
					ROOM_NO,
					MEMBER_ID,
					LAST_READ_MESSAGE_NO,
					JOINED_AT
				)
				VALUES (
					#{roomNo},
					#{userId},
					NULL,
					SYSDATE
				)
	</insert>
	
	<!-- 새로운 방에 참여자(발신자) 정보 삽입용 쿼리 -->
	<insert id="insertParticipantReciever" parameterType="map">
		INSERT INTO TB_DM_PARTICIPANT (
					ROOM_NO,
					MEMBER_ID,
					LAST_READ_MESSAGE_NO,
					JOINED_AT
				)
				VALUES (
					#{roomNo},
					#{targetUserId},
					NULL,
					SYSDATE
				)
	</insert>
	
	<!-- 메세지 저장용 쿼리 -->
	<insert id="insertMessage" parameterType="map">
		INSERT  INTO TB_DM_MESSAGE(MESSAGE_NO
                        , ROOM_NO
                        , SENDER_ID
                        , CONTENT)
				VALUES(SEQ_DM_MESSAGE_NO.NEXTVAL
						, #{roomNo}
						, #{senderId}
						, #{content})
	</insert>

	<!-- 메세지 조회용 쿼리 -->
	<select id="selectMessage" parameterType="map" resultMap="dmMessageResultSet">
		SELECT m.MESSAGE_NO
		     , m.ROOM_NO
		     , m.SENDER_ID
		     , m.CONTENT
		     , TO_CHAR(m.CREATE_DATE + (9/24), 'YYYY-MM-DD HH24:MI:SS') AS CREATE_DATE
		     , (CASE 
		          WHEN m.MESSAGE_NO &lt;= (
		              SELECT NVL(MAX(p.LAST_READ_MESSAGE_NO), 0)
		              FROM TB_DM_PARTICIPANT p
		              WHERE p.ROOM_NO = m.ROOM_NO
		                AND p.MEMBER_ID != #{senderId}
		          ) THEN 0  <!-- 상대방이 읽은 번호보다 작거나 같으면 읽음(0) -->
		          ELSE 1    <!-- 아니면 안 읽음(1) -->
		       END) AS READ_CHECK
		  FROM TB_DM_MESSAGE m
		 WHERE m.ROOM_NO = #{roomNo}
		   AND m.IS_DEL = 'N'
		 ORDER BY m.CREATE_DATE ASC
	</select>
	
	<!-- 읽음 처리 - 마지막으로 읽은 메시지 번호 업데이트 -->
	<update id="updateReadStatus" parameterType="map">
		UPDATE TB_DM_PARTICIPANT
		SET LAST_READ_MESSAGE_NO = (
		    SELECT MAX(MESSAGE_NO) FROM TB_DM_MESSAGE
		    WHERE ROOM_NO = #{roomNo}
		      AND IS_DEL = 'N'
		)
		WHERE ROOM_NO = #{roomNo}
		  AND MEMBER_ID = #{readerId}
	</update>
	
	<!-- 미읽은 메시지 개수 조회 -->
	<select id="getUnreadMessageCount" parameterType="map" resultType="int">
		SELECT COUNT(*) 
		  FROM TB_DM_MESSAGE
		 WHERE ROOM_NO = #{roomNo}
		   AND SENDER_ID != #{readerId}
		   AND IS_DEL = 'N'
		   AND MESSAGE_NO > (
		   		SELECT NVL(MAX(LAST_READ_MESSAGE_NO), 0)
		   		  FROM TB_DM_PARTICIPANT
		   		 WHERE ROOM_NO = #{roomNo}
		   		   AND MEMBER_ID = #{readerId}
		   )
	</select>

</mapper>