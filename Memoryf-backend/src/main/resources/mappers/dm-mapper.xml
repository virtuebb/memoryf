<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dmMapper">
	
	<resultMap id="dmResultSet" type="dmRoom">
		<id column="ROOM_NO" property="roomNo" />
		<result column="CREATE_DATE" property="createDate" />
		<result column="ROOM_NAME" property="roomName" />
		<!-- <result column="MEMBER_PWD" property="memberPwd" />
		<result column="MEMBER_NAME" property="memberName" />
		<result column="STATUS" property="status" /> -->
	</resultMap>

	<!-- 메세지 ResultSet -->
	<resultMap id="dmMessageResultSet" type="dmMessage">
		<id column="MESSAGE_NO" property="messageNo" />
		<result column="ROOM_NO" property="roomNo" />
		<result column="SENDER_ID" property="senderId" />
		<result column="CONTENT" property="content" />
		<result column="CREATE_DATE" property="createDate" />
	</resultMap>
	
	<!-- Dm 방 조회용 쿼리 -->
	<select id="selectDmRoomList" parameterType="string" resultMap="dmResultSet">
		SELECT r.ROOM_NO,
			   p2.MEMBER_ID AS DISPLAY_NAME,
			   MEMBER_NAME AS ROOM_NAME
		  FROM TB_DM_ROOM r
		  JOIN TB_DM_PARTICIPANT p1 ON r.ROOM_NO = p1.ROOM_NO
		  JOIN TB_DM_PARTICIPANT p2 ON r.ROOM_NO = p2.ROOM_NO
		  JOIN TB_MEMBER m ON m.MEMBER_ID = p2.MEMBER_ID
		 WHERE p1.MEMBER_ID = #{userId}
		   AND p2.MEMBER_ID != #{userId}

	</select>

	<!-- 새로운 DM 방 생성용 쿼리 -->
	<!-- selectKey로 시퀀스 값을 먼저 가져와 parameter의 roomNo에 설정하고 그걸 반환할 수 있음-->
	<insert id="insertRoom" parameterType="map" useGeneratedKeys="false">
		<selectKey keyProperty="roomNo" order="BEFORE" resultType="int">
			SELECT SEQ_DM_ROOM_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_DM_ROOM(
					  ROOM_NO)
		       VALUES(
					  #{roomNo})
	</insert>

	<!-- 새로운 방에 참여자(발신자) 정보 삽입용 쿼리 -->
	<insert id="insertParticipantSender" parameterType="map">
		INSERT INTO TB_DM_PARTICIPANT (
					ROOM_NO,
					MEMBER_ID,
					LAST_READ_MESSAGE_NO,
					JOINED_AT
				)
				VALUES (
					#{roomNo},
					#{userId},
					NULL,
					SYSDATE
				)
	</insert>
	
	<!-- 새로운 방에 참여자(발신자) 정보 삽입용 쿼리 -->
	<insert id="insertParticipantReciever" parameterType="map">
		INSERT INTO TB_DM_PARTICIPANT (
					ROOM_NO,
					MEMBER_ID,
					LAST_READ_MESSAGE_NO,
					JOINED_AT
				)
				VALUES (
					#{roomNo},
					#{targetUserId},
					NULL,
					SYSDATE
				)
	</insert>
	
	<!-- 메세지 저장용 쿼리 -->
	<insert id="insertMessage" parameterType="map">
		INSERT  INTO TB_DM_MESSAGE(MESSAGE_NO
                        , ROOM_NO
                        , SENDER_ID
                        , CONTENT)
				VALUES(SEQ_DM_MESSAGE_NO.NEXTVAL
						, #{roomNo}
						, #{senderId}
						, #{content})
	</insert>

	<!-- 메세지 조회용 쿼리 -->
	<select id="selectMessage" parameterType="map" resultMap="dmMessageResultSet">
		SELECT MESSAGE_NO
		     , ROOM_NO
		     , SENDER_ID
		     , CONTENT
		     , CREATE_DATE
		  FROM TB_DM_MESSAGE
		 WHERE ROOM_NO = #{roomNo}
		   AND IS_DEL = 'N'
		 ORDER BY CREATE_DATE ASC
	</select>

</mapper>