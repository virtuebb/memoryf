<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="notificationMapper">

    <resultMap type="notification" id="notificationResultMap">
        <id property="notificationNo" column="NOTIFICATION_NO"/>
        <result property="receiverNo" column="RECEIVER_NO"/>
        <result property="senderNo" column="SENDER_NO"/>
        <result property="type" column="NOTIFICATION_TYPE"/>
        <result property="targetId" column="TARGET_NO"/>
        <result property="targetSubId" column="TARGET_SUB_NO"/>
        <result property="isRead" column="IS_READ"/>
        <result property="createDate" column="CREATED_AT"/>
        <result property="senderNick" column="SENDER_NICK"/>
        <result property="senderProfile" column="SENDER_PROFILE"/>
        <result property="senderStatus" column="SENDER_STATUS"/>
        <result property="feedImage" column="FEED_IMAGE"/>
    </resultMap>

    <insert id="insertNotification" parameterType="notification">
        INSERT INTO TB_NOTIFICATION (
            NOTIFICATION_NO,
            RECEIVER_NO,
            SENDER_NO,
            NOTIFICATION_TYPE,
            TARGET_TYPE,
            TARGET_NO,
            IS_READ,
            CREATED_AT
        ) VALUES (
            SEQ_NOTIFICATION_NO.NEXTVAL,
            #{receiverNo},
            #{senderNo},
            #{type},
            #{targetType},
            #{targetId},
            'N',
            SYSDATE
        )
    </insert>

    <select id="selectNotificationList" parameterType="_int" resultMap="notificationResultMap">
        SELECT 
            N.NOTIFICATION_NO,
            N.RECEIVER_NO,
            N.SENDER_NO,
            N.NOTIFICATION_TYPE,
            N.TARGET_TYPE,
            N.TARGET_NO,
            N.IS_READ,
            N.CREATED_AT,
            M.MEMBER_NICK AS SENDER_NICK,
            M.ACCOUNT_STATUS AS SENDER_STATUS,
            H.PROFILE_SAVED_NAME AS SENDER_PROFILE,
            (SELECT SAVED_NAME FROM TB_FEED_FILE WHERE FEED_NO = N.TARGET_NO AND ROWNUM = 1) AS FEED_IMAGE
        FROM TB_NOTIFICATION N
        JOIN TB_MEMBER M ON N.SENDER_NO = M.MEMBER_NO
        JOIN TB_MEMBER_HOME H ON M.MEMBER_NO = H.MEMBER_NO
        WHERE N.RECEIVER_NO = #{memberNo}
        ORDER BY N.CREATED_AT DESC
    </select>

    <update id="updateReadStatus" parameterType="_int">
        UPDATE TB_NOTIFICATION
        SET IS_READ = 'Y'
        WHERE NOTIFICATION_NO = #{notificationNo}
    </update>

    <delete id="deleteNotification" parameterType="_int">
        DELETE FROM TB_NOTIFICATION
        WHERE NOTIFICATION_NO = #{notificationNo}
    </delete>

    <delete id="deleteFollowRequestNotifications" parameterType="map">
        DELETE FROM TB_NOTIFICATION
        WHERE RECEIVER_NO = #{receiverNo}
          AND SENDER_NO = #{senderNo}
          AND TYPE = 'FOLLOW_REQUEST'
    </delete>

    <select id="getUnreadCount" parameterType="_int" resultType="_int">
        SELECT COUNT(*)
        FROM TB_NOTIFICATION
        WHERE RECEIVER_NO = #{memberNo}
        AND IS_READ = 'N'
    </select>

</mapper>
