<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="paymentMapper">

	<!-- 포인트 충전 내역 삽입 -->
	<insert id="insertPointCharge">
		INSERT INTO TB_POINT_CHARGE (
			CHARGE_NO, MEMBER_NO, CHARGE_AMOUNT, IMP_UID, MERCHANT_UID, PAYMENT_METHOD, STATUS
		) VALUES (
			SEQ_CHARGE_NO.NEXTVAL, #{memberNo}, #{chargeAmount}, #{impUid}, #{merchantUid}, #{paymentMethod}, #{status}
		)
	</insert>
	
	<!-- 회원 포인트 업데이트 -->
	<update id="updateMemberPoint">
		UPDATE TB_MEMBER
		SET POINT = POINT + #{amount}
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<!-- BGM 전체 목록 조회 -->
	<select id="selectAllBgmList" resultType="bgm">
		SELECT 
			BGM_NO,
			BGM_TITLE,
			FILE_PATH,
			ARTIST,
			PRICE,
			REG_DATE,
			FILE_PATH as videoId
		FROM TB_BGM
		ORDER BY REG_DATE DESC
	</select>
	
	<!-- 회원이 구매한 BGM 목록 조회 -->
	<select id="selectPurchasedBgmList" resultType="bgm">
		SELECT 
			B.BGM_NO,
			B.BGM_TITLE,
			B.FILE_PATH,
			B.ARTIST,
			B.PRICE,
			B.REG_DATE,
			B.FILE_PATH as videoId
		FROM TB_BGM B
		JOIN TB_PAYMENT P ON B.BGM_NO = P.BGM_NO
		WHERE P.MEMBER_NO = #{memberNo}
		  AND P.PAYMENT_TYPE = 'BGM'
		ORDER BY P.PAYMENT_DATE DESC
	</select>
	
	<!-- BGM 상세 조회 -->
	<select id="selectBgmByNo" resultType="bgm">
		SELECT 
			BGM_NO,
			BGM_TITLE,
			FILE_PATH,
			ARTIST,
			PRICE,
			REG_DATE,
			FILE_PATH as videoId
		FROM TB_BGM
		WHERE BGM_NO = #{bgmNo}
	</select>
	
	<!-- BGM 조회 (제목, 가수) -->
	<select id="selectBgmByTitleAndArtist" resultType="bgm">
		SELECT 
			BGM_NO,
			BGM_TITLE,
			FILE_PATH,
			ARTIST,
			PRICE,
			REG_DATE,
			FILE_PATH as videoId
		FROM TB_BGM
		WHERE BGM_TITLE = #{title}
		  AND ARTIST = #{artist}
	</select>
	
	<!-- BGM 등록 -->
	<insert id="insertBgm">
		<selectKey keyProperty="bgmNo" resultType="int" order="BEFORE">
			SELECT SEQ_BGM_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_BGM (
			BGM_NO, BGM_TITLE, ARTIST, PRICE, REG_DATE, FILE_PATH
		) VALUES (
			#{bgmNo}, #{bgmTitle}, #{artist}, #{price}, SYSDATE, #{videoId}
		)
	</insert>
	
	<!-- 구매 여부 확인 -->
	<select id="checkPurchased" resultType="int">
		SELECT COUNT(*)
		FROM TB_PAYMENT
		WHERE MEMBER_NO = #{memberNo}
		  AND BGM_NO = #{bgmNo}
		  AND PAYMENT_TYPE = 'BGM'
	</select>
	
	<!-- BGM 구매 내역 삽입 -->
	<insert id="insertBgmPayment">
		INSERT INTO TB_PAYMENT (
			PAYMENT_NO, PAYMENT_AMOUNT, BGM_NO, MEMBER_NO, PAYMENT_TYPE
		) VALUES (
			SEQ_PAYMENT_NO.NEXTVAL, #{paymentAmount}, #{bgmNo}, #{memberNo}, 'BGM'
		)
	</insert>
	
	<!-- 회원 포인트 차감 -->
	<update id="deductMemberPoint">
		UPDATE TB_MEMBER
		SET POINT = POINT - #{amount}
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<!-- 회원 포인트 조회 -->
	<select id="selectMemberPoint" resultType="int">
		SELECT POINT
		FROM TB_MEMBER
		WHERE MEMBER_NO = #{memberNo}
	</select>
	
	<!-- 결제 내역 조회 (충전 + 사용) -->
	<select id="selectPaymentHistory" resultType="com.kh.memoryf.payment.model.dto.PaymentHistoryDto">
		SELECT 
			'CHARGE' AS type,
			CHARGE_AMOUNT AS amount,
			CHARGE_DATE AS date,
			'포인트 충전' AS description,
			STATUS AS status
		FROM TB_POINT_CHARGE
		WHERE MEMBER_NO = #{memberNo}
		
		UNION ALL
		
		SELECT 
			'USE' AS type,
			P.PAYMENT_AMOUNT AS amount,
			P.PAYMENT_DATE AS date,
			'BGM 구매: ' || B.BGM_TITLE AS description,
			'COMPLETED' AS status
		FROM TB_PAYMENT P
		JOIN TB_BGM B ON P.BGM_NO = B.BGM_NO
		WHERE P.MEMBER_NO = #{memberNo}
		  AND P.PAYMENT_TYPE = 'BGM'
		
		ORDER BY date DESC
	</select>

</mapper>
