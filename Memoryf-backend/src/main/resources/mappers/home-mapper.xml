<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="homeMapper">

	<!-- 회원 번호로 홈 조회 (통계 포함) -->
	<select id="selectHomeByMemberNo" parameterType="hashmap" resultMap="homeResultMap">
		SELECT 
			H.HOME_NO,
			H.HOME_TITLE,
			H.STATUS_MESSAGE,
			H.PROFILE_ORIGIN_NAME,
			H.PROFILE_SAVED_NAME,
			H.IS_PROFILE_PRIVATE,
			H.IS_VISITOR_PRIVATE,
			H.IS_FOLLOW_PRIVATE,
			H.MEMBER_NO,
			M.MEMBER_ID,
			M.MEMBER_NICK,
			M.MEMBER_NAME,
			M.ACCOUNT_STATUS,
			NVL(FEED_CNT.FEED_COUNT, 0) AS FEED_COUNT,
			NVL(FOLLOWER_CNT.FOLLOWER_COUNT, 0) AS FOLLOWER_COUNT,
			NVL(FOLLOWING_CNT.FOLLOWING_COUNT, 0) AS FOLLOWING_COUNT,
			CASE WHEN (SELECT COUNT(*) FROM TB_STORY S WHERE S.MEMBER_NO = H.MEMBER_NO AND S.IS_DELETED = 'N' AND S.EXPIRED_AT > SYSDATE) > 0 THEN 1 ELSE 0 END AS HAS_STORY
			<if test="currentMemberNo != null">
				, CASE WHEN (SELECT COUNT(*) FROM TB_STORY S WHERE S.MEMBER_NO = H.MEMBER_NO AND S.IS_DELETED = 'N' AND S.EXPIRED_AT > SYSDATE AND NOT EXISTS (SELECT 1 FROM TB_STORY_VISITOR V WHERE V.STORY_NO = S.STORY_NO AND V.MEMBER_NO = #{currentMemberNo})) > 0 THEN 1 ELSE 0 END AS HAS_UNREAD_STORY
				, CASE WHEN FLW.MEMBER_NO IS NOT NULL THEN 1 ELSE 0 END AS IS_FOLLOWING
				, FLW.STATUS AS FOLLOW_STATUS
			</if>
		FROM TB_MEMBER_HOME H
		LEFT JOIN TB_MEMBER M ON H.MEMBER_NO = M.MEMBER_NO
		LEFT JOIN (
			SELECT MEMBER_NO, COUNT(*) AS FEED_COUNT
			FROM TB_FEED
			WHERE IS_DELETED = 'N'
			GROUP BY MEMBER_NO
		) FEED_CNT ON H.MEMBER_NO = FEED_CNT.MEMBER_NO
		LEFT JOIN (
			SELECT HOME_NO, COUNT(*) AS FOLLOWER_COUNT
			FROM TB_FOLLOWS
			WHERE STATUS = 'Y'
			GROUP BY HOME_NO
		) FOLLOWER_CNT ON H.HOME_NO = FOLLOWER_CNT.HOME_NO
		LEFT JOIN (
			SELECT MEMBER_NO, COUNT(*) AS FOLLOWING_COUNT
			FROM TB_FOLLOWS
			WHERE STATUS = 'Y'
			GROUP BY MEMBER_NO
		) FOLLOWING_CNT ON H.MEMBER_NO = FOLLOWING_CNT.MEMBER_NO
		<if test="currentMemberNo != null">
			LEFT JOIN TB_FOLLOWS FLW ON H.HOME_NO = FLW.HOME_NO AND FLW.MEMBER_NO = #{currentMemberNo}
		</if>
		WHERE H.MEMBER_NO = #{memberNo}
	</select>

	<!-- 홈 번호로 홈 조회 -->
	<select id="selectHomeByHomeNo" parameterType="hashmap" resultMap="homeResultMap">
		SELECT 
			H.HOME_NO,
			H.HOME_TITLE,
			H.STATUS_MESSAGE,
			H.PROFILE_ORIGIN_NAME,
			H.PROFILE_SAVED_NAME,
			H.IS_PROFILE_PRIVATE,
			H.IS_VISITOR_PRIVATE,
			H.IS_FOLLOW_PRIVATE,
			H.MEMBER_NO,
			M.MEMBER_ID,
			M.MEMBER_NICK,
			M.MEMBER_NAME,
			M.ACCOUNT_STATUS,
			NVL(FEED_CNT.FEED_COUNT, 0) AS FEED_COUNT,
			NVL(FOLLOWER_CNT.FOLLOWER_COUNT, 0) AS FOLLOWER_COUNT,
			NVL(FOLLOWING_CNT.FOLLOWING_COUNT, 0) AS FOLLOWING_COUNT,
			CASE WHEN (SELECT COUNT(*) FROM TB_STORY S WHERE S.MEMBER_NO = H.MEMBER_NO AND S.IS_DELETED = 'N' AND S.EXPIRED_AT > SYSDATE) > 0 THEN 1 ELSE 0 END AS HAS_STORY
			<if test="currentMemberNo != null">
				, CASE WHEN (SELECT COUNT(*) FROM TB_STORY S WHERE S.MEMBER_NO = H.MEMBER_NO AND S.IS_DELETED = 'N' AND S.EXPIRED_AT > SYSDATE AND NOT EXISTS (SELECT 1 FROM TB_STORY_VISITOR V WHERE V.STORY_NO = S.STORY_NO AND V.MEMBER_NO = #{currentMemberNo})) > 0 THEN 1 ELSE 0 END AS HAS_UNREAD_STORY
				, CASE WHEN FLW.MEMBER_NO IS NOT NULL THEN 1 ELSE 0 END AS IS_FOLLOWING
				, FLW.STATUS AS FOLLOW_STATUS
			</if>
		FROM TB_MEMBER_HOME H
		LEFT JOIN TB_MEMBER M ON H.MEMBER_NO = M.MEMBER_NO
		LEFT JOIN (
			SELECT MEMBER_NO, COUNT(*) AS FEED_COUNT
			FROM TB_FEED
			WHERE IS_DELETED = 'N'
			GROUP BY MEMBER_NO
		) FEED_CNT ON H.MEMBER_NO = FEED_CNT.MEMBER_NO
		LEFT JOIN (
			SELECT HOME_NO, COUNT(*) AS FOLLOWER_COUNT
			FROM TB_FOLLOWS
			WHERE STATUS = 'Y'
			GROUP BY HOME_NO
		) FOLLOWER_CNT ON H.HOME_NO = FOLLOWER_CNT.HOME_NO
		LEFT JOIN (
			SELECT MEMBER_NO, COUNT(*) AS FOLLOWING_COUNT
			FROM TB_FOLLOWS
			WHERE STATUS = 'Y'
			GROUP BY MEMBER_NO
		) FOLLOWING_CNT ON H.MEMBER_NO = FOLLOWING_CNT.MEMBER_NO
		<if test="currentMemberNo != null">
			LEFT JOIN TB_FOLLOWS FLW ON H.HOME_NO = FLW.HOME_NO AND FLW.MEMBER_NO = #{currentMemberNo}
		</if>
		WHERE H.HOME_NO = #{homeNo}
	</select>

	<!-- 방명록 목록 조회 -->
	<select id="selectGuestbookList" parameterType="hashmap" resultMap="guestbookResultMap">
		SELECT *
		FROM (
			SELECT
				G.GUESTBOOK_NO,
				G.CONTENT,
				G.CREATED_AT,
				G.IS_DELETED,
				G.MEMBER_NO,
				G.HOME_NO,
				M.MEMBER_NICK,
				M.ACCOUNT_STATUS,
				H.PROFILE_SAVED_NAME,
				NVL(LIKE_CNT.LIKE_COUNT, 0) AS LIKE_COUNT,
				<if test="currentMemberNo != null">
					CASE WHEN GL.MEMBER_NO IS NOT NULL THEN 1 ELSE 0 END AS IS_LIKED,
				</if>
				ROWNUM AS RNUM
			FROM (
				SELECT
					G.GUESTBOOK_NO,
					G.GUESTBOOK_CONTENT,
					G.CREATE_DATE,
					G.IS_DEL,
					G.MEMBER_NO,
					G.HOME_NO
				FROM TB_GUESTBOOK G
				WHERE G.HOME_NO = #{homeNo}
				  AND G.IS_DELETED = 'N'
				ORDER BY G.CREATED_AT DESC
			) G
			LEFT JOIN TB_MEMBER M ON G.MEMBER_NO = M.MEMBER_NO
			LEFT JOIN TB_MEMBER_HOME H ON M.MEMBER_NO = H.MEMBER_NO
			LEFT JOIN (
				SELECT GUESTBOOK_NO, COUNT(*) AS LIKE_COUNT
				FROM TB_GUESTBOOK_LIKE
				GROUP BY GUESTBOOK_NO
			) LIKE_CNT ON G.GUESTBOOK_NO = LIKE_CNT.GUESTBOOK_NO
			<if test="currentMemberNo != null">
				LEFT JOIN TB_GUESTBOOK_LIKE GL ON G.GUESTBOOK_NO = GL.GUESTBOOK_NO AND GL.MEMBER_NO = #{currentMemberNo}
			</if>
			WHERE ROWNUM <![CDATA[<=]]> #{offset} + #{limit}
		)
		WHERE RNUM > #{offset}
	</select>

	<!-- 방명록 생성 -->
	<insert id="insertGuestbook" parameterType="guestbook">
		INSERT INTO TB_GUESTBOOK (
			GUESTBOOK_NO,
			CONTENT,
			CREATED_AT,
			IS_DELETED,
			MEMBER_NO,
			HOME_NO
		) VALUES (
			SEQ_GUESTBOOK_NO.NEXTVAL,
			#{guestbookContent},
			SYSDATE,
			'N',
			#{memberNo},
			#{homeNo}
		)
	</insert>

	<!-- 방명록 삭제 (IS_DEL = 'Y') -->
	<update id="deleteGuestbook" parameterType="_int">
		UPDATE TB_GUESTBOOK
		SET IS_DELETED = 'Y'
		WHERE GUESTBOOK_NO = #{guestbookNo}
	</update>

	<!-- 방명록 좋아요 추가 -->
	<insert id="insertGuestbookLike" parameterType="hashmap">
		INSERT INTO TB_GUESTBOOK_LIKE (
			MEMBER_NO,
			GUESTBOOK_NO
		) VALUES (
			#{memberNo},
			#{guestbookNo}
		)
	</insert>

	<!-- 방명록 좋아요 삭제 -->
	<delete id="deleteGuestbookLike" parameterType="hashmap">
		DELETE FROM TB_GUESTBOOK_LIKE
		WHERE MEMBER_NO = #{memberNo}
		AND GUESTBOOK_NO = #{guestbookNo}
	</delete>

	<!-- 방명록 좋아요 여부 확인 -->
	<select id="checkGuestbookLike" parameterType="hashmap" resultType="_int">
		SELECT COUNT(*)
		FROM TB_GUESTBOOK_LIKE
		WHERE MEMBER_NO = #{memberNo}
		AND GUESTBOOK_NO = #{guestbookNo}
	</select>

	<!-- 프로필 이미지 업데이트 -->
	<update id="updateProfileImage" parameterType="home">
		UPDATE TB_MEMBER_HOME
		SET PROFILE_ORIGIN_NAME = #{profileOriginName},
			PROFILE_SAVED_NAME = #{profileSavedName}
		WHERE MEMBER_NO = #{memberNo}
	</update>

	<!-- 상태 메시지 업데이트 -->
	<update id="updateStatusMsg" parameterType="home">
		UPDATE TB_MEMBER_HOME
		SET STATUS_MESSAGE = #{statusMessage}
		WHERE MEMBER_NO = #{memberNo}
	</update>

	<!-- 계정 공개 범위 업데이트 -->
	<update id="updatePrivacy" parameterType="home">
		UPDATE TB_MEMBER_HOME
		SET IS_PROFILE_PRIVATE = #{isProfilePrivate}
		WHERE MEMBER_NO = #{memberNo}
	</update>

	<!-- ResultMap: Home -->
	<resultMap type="home" id="homeResultMap">
		<id property="homeNo" column="HOME_NO"/>
		<result property="homeTitle" column="HOME_TITLE"/>
		<result property="statusMessage" column="STATUS_MESSAGE"/>
		<result property="profileOriginName" column="PROFILE_ORIGIN_NAME"/>
		<result property="profileSavedName" column="PROFILE_SAVED_NAME"/>
		<result property="isProfilePrivate" column="IS_PROFILE_PRIVATE"/>
		<result property="isVisitorPrivate" column="IS_VISITOR_PRIVATE"/>
		<result property="isFollowPrivate" column="IS_FOLLOW_PRIVATE"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="memberId" column="MEMBER_ID"/>
		<result property="memberNick" column="MEMBER_NICK"/>
		<result property="memberName" column="MEMBER_NAME"/>
		<result property="feedCount" column="FEED_COUNT"/>
		<result property="followerCount" column="FOLLOWER_COUNT"/>
		<result property="followingCount" column="FOLLOWING_COUNT"/>
		<result property="isFollowing" column="IS_FOLLOWING"/>
		<result property="followStatus" column="FOLLOW_STATUS"/>
		<result property="hasStory" column="HAS_STORY"/>
		<result property="hasUnreadStory" column="HAS_UNREAD_STORY"/>
	</resultMap>

	<!-- ResultMap: Guestbook -->
	<resultMap type="guestbook" id="guestbookResultMap">
		<id property="guestbookNo" column="GUESTBOOK_NO"/>
		<result property="content" column="CONTENT"/>
		<result property="createdAt" column="CREATED_AT"/>
		<result property="isDeleted" column="IS_DELETED"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="homeNo" column="HOME_NO"/>
		<result property="memberNick" column="MEMBER_NICK"/>
		<result property="profileSavedName" column="PROFILE_SAVED_NAME"/>
		<result property="likeCount" column="LIKE_COUNT"/>
		<result property="isLiked" column="IS_LIKED"/>
	</resultMap>

</mapper>
