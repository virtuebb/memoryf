<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="searchMapper">

	<!-- 회원 검색 (닉네임) -->
	<select id="searchMembers" parameterType="string" resultMap="memberSearchResultMap">
		SELECT 
			M.MEMBER_NO,
			M.MEMBER_NICK,
			M.MEMBER_NAME,
			MH.PROFILE_SAVED_NAME AS PROFILE_IMAGE
		FROM TB_MEMBER M
		LEFT JOIN TB_MEMBER_HOME MH ON M.MEMBER_NO = MH.MEMBER_NO
		WHERE M.ACCOUNT_STATUS = 'ACTIVE'
		AND (
			M.MEMBER_NICK LIKE '%' || #{keyword} || '%'
			OR M.MEMBER_NAME LIKE '%' || #{keyword} || '%'
		)
		ORDER BY M.MEMBER_NICK ASC
	</select>

	<!-- 태그 검색 (피드) -->
	<select id="searchFeedsByTag" parameterType="string" resultMap="feedSearchResultMap">
		SELECT 
			F.FEED_NO,
			F.CONTENT,
			F.TAG,
			F.CREATED_AT,
			F.MEMBER_NO,
			(SELECT COUNT(*) FROM TB_FEED_LIKE WHERE FEED_NO = F.FEED_NO) AS LIKE_COUNT,
			(SELECT COUNT(*) FROM TB_COMMENT WHERE FEED_NO = F.FEED_NO AND IS_DELETED = 'N') AS COMMENT_COUNT
		FROM TB_FEED F
		WHERE F.IS_DELETED = 'N'
		AND F.TAG LIKE '%' || #{keyword} || '%'
		ORDER BY F.CREATED_AT DESC
	</select>
	
	<!-- 피드 파일 목록 조회 (컬렉션용) -->
	<select id="selectFeedFileList" parameterType="_int" resultMap="feedFileResultMap">
		SELECT 
			FILE_NO,
			ORIGIN_NAME,
			SAVED_NAME,
			FILE_PATH,
			CREATED_AT,
			IS_DELETED,
			FEED_NO
		FROM TB_FEED_FILE
		WHERE FEED_NO = #{feedNo}
		AND (IS_DELETED = 'N' OR IS_DELETED IS NULL)
		ORDER BY FILE_ORDER, FILE_NO
	</select>

	<!-- ResultMap: Member (검색용) -->
	<resultMap type="com.kh.memoryf.member.model.vo.Member" id="memberSearchResultMap">
		<id property="memberNo" column="MEMBER_NO"/>
		<result property="memberNick" column="MEMBER_NICK"/>
		<result property="memberName" column="MEMBER_NAME"/>
		<!-- Member VO에 profileImage 필드가 없으면 추가하거나 확장해야 함. 
		     현재 Member VO에는 없지만 Feed VO 등에서 조인용으로 사용 중.
		     Member VO에 profileImage 필드가 있는지 확인 필요. 
		     없다면 Member VO 수정 혹은 HashMap 사용.
		     일단 Member VO 확인 후 진행. -->
		<result property="profileImage" column="PROFILE_IMAGE"/>
	</resultMap>

	<!-- ResultMap: Feed (검색용) -->
	<resultMap type="com.kh.memoryf.feed.model.vo.Feed" id="feedSearchResultMap">
		<id property="feedNo" column="FEED_NO"/>
		<result property="content" column="CONTENT"/>
		<result property="tag" column="TAG"/>
		<result property="createdAt" column="CREATED_AT"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="likeCount" column="LIKE_COUNT"/>
		<result property="commentCount" column="COMMENT_COUNT"/>
		<collection property="feedFiles" ofType="com.kh.memoryf.feed.model.vo.FeedFile" select="selectFeedFileList" column="FEED_NO" fetchType="eager"/>
	</resultMap>
	
	<!-- ResultMap: FeedFile -->
	<resultMap type="com.kh.memoryf.feed.model.vo.FeedFile" id="feedFileResultMap">
		<id property="fileNo" column="FILE_NO"/>
		<result property="savedName" column="SAVED_NAME"/>
		<result property="filePath" column="FILE_PATH"/>
		<result property="feedNo" column="FEED_NO"/>
	</resultMap>

</mapper>
