<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="feedMapper">

	<!-- 피드 목록 조회 (정렬 옵션 포함) -->
	<select id="selectFeedList" parameterType="hashmap" resultMap="feedResultMap">
		<choose>
			<!-- 페이지네이션: startRow/endRow가 넘어오면 ROW_NUMBER()로 슬라이싱 -->
			<when test="startRow != null and endRow != null">
				SELECT *
				FROM (
					SELECT T.*, ROW_NUMBER() OVER (
						<choose>
							<when test="sortBy == 'popular'">
								ORDER BY LIKE_COUNT DESC, CREATED_AT DESC
							</when>
							<otherwise>
								ORDER BY CREATED_AT DESC
							</otherwise>
						</choose>
					) AS RN
					FROM (
						SELECT 
							F.FEED_NO,
							F.CONTENT,
							F.TAG,
							F.LATITUDE,
							F.LONGITUDE,
							F.LOCATION_NAME,
							F.CREATED_AT,
							F.IS_DELETED,
							F.MEMBER_NO,
							M.MEMBER_NICK,
							M.ACCOUNT_STATUS AS MEMBER_STATUS,
							NVL(LIKE_CNT.LIKE_COUNT, 0) AS LIKE_COUNT,
							NVL(COMMENT_CNT.COMMENT_COUNT, 0) AS COMMENT_COUNT
							, CASE WHEN (SELECT COUNT(*) FROM TB_STORY S WHERE S.MEMBER_NO = F.MEMBER_NO AND S.IS_DELETED = 'N' AND S.EXPIRED_AT > SYSDATE) > 0 THEN 1 ELSE 0 END AS HAS_STORY
							<if test="memberNo != null">
								, CASE WHEN (SELECT COUNT(*) FROM TB_STORY S WHERE S.MEMBER_NO = F.MEMBER_NO AND S.IS_DELETED = 'N' AND S.EXPIRED_AT > SYSDATE AND NOT EXISTS (SELECT 1 FROM TB_STORY_VISITOR V WHERE V.STORY_NO = S.STORY_NO AND V.MEMBER_NO = #{memberNo})) > 0 THEN 1 ELSE 0 END AS HAS_UNREAD_STORY
								, CASE WHEN FL.MEMBER_NO IS NOT NULL THEN 1 ELSE 0 END AS IS_LIKED
							</if>
						FROM TB_FEED F
						LEFT JOIN TB_MEMBER M ON F.MEMBER_NO = M.MEMBER_NO
						LEFT JOIN (
							SELECT FEED_NO, COUNT(*) AS LIKE_COUNT
							FROM TB_FEED_LIKE
							GROUP BY FEED_NO
						) LIKE_CNT ON F.FEED_NO = LIKE_CNT.FEED_NO
						LEFT JOIN (
							SELECT FEED_NO, COUNT(*) AS COMMENT_COUNT
							FROM TB_COMMENT
							WHERE IS_DELETED = 'N'
							GROUP BY FEED_NO
						) COMMENT_CNT ON F.FEED_NO = COMMENT_CNT.FEED_NO
						<if test="memberNo != null">
							LEFT JOIN TB_FEED_LIKE FL ON F.FEED_NO = FL.FEED_NO AND FL.MEMBER_NO = #{memberNo}
						</if>
						LEFT JOIN TB_MEMBER_HOME MH_CHECK ON F.MEMBER_NO = MH_CHECK.MEMBER_NO
						WHERE F.IS_DELETED = 'N'
						<if test="memberNo == null">
							AND MH_CHECK.IS_PROFILE_PRIVATE = 'N'
						</if>
						<if test="memberNo != null">
							AND (
								MH_CHECK.IS_PROFILE_PRIVATE = 'N'
								OR F.MEMBER_NO = #{memberNo}
								OR (
									MH_CHECK.IS_PROFILE_PRIVATE = 'Y'
									AND EXISTS (
										SELECT 1
										FROM TB_FOLLOWS FLW
										WHERE FLW.MEMBER_NO = #{memberNo}
										AND FLW.HOME_NO = MH_CHECK.HOME_NO
										AND FLW.STATUS = 'Y'
									)
								)
							)
						</if>
						<if test="targetMemberNo != null">
							AND F.MEMBER_NO = #{targetMemberNo}
						</if>
						<if test="sortBy == 'following' and memberNo != null">
							AND F.MEMBER_NO IN (
								SELECT MH.MEMBER_NO
								FROM TB_FOLLOWS FLW
								JOIN TB_MEMBER_HOME MH ON FLW.HOME_NO = MH.HOME_NO
								WHERE FLW.MEMBER_NO = #{memberNo}
								AND FLW.STATUS = 'Y'
							)
						</if>
					) T
				)
				WHERE RN BETWEEN #{startRow} AND #{endRow}
			</when>
			<!-- 기존: 전체 목록 반환 -->
			<otherwise>
				SELECT 
					F.FEED_NO,
					F.CONTENT,
					F.TAG,
					F.LATITUDE,
					F.LONGITUDE,
					F.LOCATION_NAME,
					F.CREATED_AT,
					F.IS_DELETED,
					F.MEMBER_NO,
					M.MEMBER_NICK,
					NVL(LIKE_CNT.LIKE_COUNT, 0) AS LIKE_COUNT,
					NVL(COMMENT_CNT.COMMENT_COUNT, 0) AS COMMENT_COUNT,
					CASE WHEN (SELECT COUNT(*) FROM TB_STORY S WHERE S.MEMBER_NO = F.MEMBER_NO AND S.IS_DELETED = 'N' AND S.EXPIRED_AT > SYSDATE) > 0 THEN 1 ELSE 0 END AS HAS_STORY
					<if test="memberNo != null">
						, CASE WHEN FL.MEMBER_NO IS NOT NULL THEN 1 ELSE 0 END AS IS_LIKED
					</if>
				FROM TB_FEED F
				LEFT JOIN TB_MEMBER M ON F.MEMBER_NO = M.MEMBER_NO
				LEFT JOIN (
					SELECT FEED_NO, COUNT(*) AS LIKE_COUNT
					FROM TB_FEED_LIKE
					GROUP BY FEED_NO
				) LIKE_CNT ON F.FEED_NO = LIKE_CNT.FEED_NO
				LEFT JOIN (
					SELECT FEED_NO, COUNT(*) AS COMMENT_COUNT
					FROM TB_COMMENT
					WHERE IS_DELETED = 'N'
					GROUP BY FEED_NO
				) COMMENT_CNT ON F.FEED_NO = COMMENT_CNT.FEED_NO
				<if test="memberNo != null">
					LEFT JOIN TB_FEED_LIKE FL ON F.FEED_NO = FL.FEED_NO AND FL.MEMBER_NO = #{memberNo}
				</if>
				LEFT JOIN TB_MEMBER_HOME MH_CHECK ON F.MEMBER_NO = MH_CHECK.MEMBER_NO
				WHERE F.IS_DELETED = 'N'
				<if test="memberNo == null">
					AND MH_CHECK.IS_PROFILE_PRIVATE = 'N'
				</if>
				<if test="memberNo != null">
					AND (
						MH_CHECK.IS_PROFILE_PRIVATE = 'N'
						OR F.MEMBER_NO = #{memberNo}
						OR (
							MH_CHECK.IS_PROFILE_PRIVATE = 'Y'
							AND EXISTS (
								SELECT 1
								FROM TB_FOLLOWS FLW
								WHERE FLW.MEMBER_NO = #{memberNo}
								AND FLW.HOME_NO = MH_CHECK.HOME_NO
								AND FLW.STATUS = 'Y'
							)
						)
					)
				</if>
				<if test="targetMemberNo != null">
					AND F.MEMBER_NO = #{targetMemberNo}
				</if>
					<if test="sortBy == 'following' and memberNo != null">
						AND F.MEMBER_NO IN (
							SELECT MH.MEMBER_NO
							FROM TB_FOLLOWS FLW
							JOIN TB_MEMBER_HOME MH ON FLW.HOME_NO = MH.HOME_NO
							WHERE FLW.MEMBER_NO = #{memberNo}
							AND FLW.STATUS = 'Y'
						)
					</if>
				<choose>
					<when test="sortBy == 'popular'">
						ORDER BY LIKE_COUNT DESC, F.CREATED_AT DESC
					</when>
					<when test="sortBy == 'following'">
						ORDER BY F.CREATED_AT DESC
					</when>
					<otherwise>
						ORDER BY F.CREATED_AT DESC
					</otherwise>
				</choose>
			</otherwise>
		</choose>
	</select>

	<!-- 피드 상세 조회 -->
	<select id="selectFeed" parameterType="hashmap" resultMap="feedResultMap">
		SELECT 
			F.FEED_NO,
			F.CONTENT,
			F.TAG,
			F.LATITUDE,
			F.LONGITUDE,
			F.LOCATION_NAME,
			F.CREATED_AT,
			F.IS_DELETED,
			F.MEMBER_NO,
			M.MEMBER_NICK,
			M.ACCOUNT_STATUS AS MEMBER_STATUS,
			H.PROFILE_SAVED_NAME AS PROFILE_IMAGE,
			NVL(LIKE_CNT.LIKE_COUNT, 0) AS LIKE_COUNT,
			NVL(COMMENT_CNT.COMMENT_COUNT, 0) AS COMMENT_COUNT,
			CASE WHEN (SELECT COUNT(*) FROM TB_STORY S WHERE S.MEMBER_NO = F.MEMBER_NO AND S.IS_DELETED = 'N' AND S.EXPIRED_AT > SYSDATE) > 0 THEN 1 ELSE 0 END AS HAS_STORY
			<if test="memberNo != null">
				, CASE WHEN (SELECT COUNT(*) FROM TB_STORY S WHERE S.MEMBER_NO = F.MEMBER_NO AND S.IS_DELETED = 'N' AND S.EXPIRED_AT > SYSDATE AND NOT EXISTS (SELECT 1 FROM TB_STORY_VISITOR V WHERE V.STORY_NO = S.STORY_NO AND V.MEMBER_NO = #{memberNo})) > 0 THEN 1 ELSE 0 END AS HAS_UNREAD_STORY
				, CASE WHEN FL.MEMBER_NO IS NOT NULL THEN 1 ELSE 0 END AS IS_LIKED
				, CASE WHEN FB.MEMBER_NO IS NOT NULL THEN 1 ELSE 0 END AS IS_BOOKMARKED
			</if>
		FROM TB_FEED F
		LEFT JOIN TB_MEMBER M ON F.MEMBER_NO = M.MEMBER_NO
		LEFT JOIN TB_MEMBER_HOME H ON F.MEMBER_NO = H.MEMBER_NO
		LEFT JOIN (
			SELECT FEED_NO, COUNT(*) AS LIKE_COUNT
			FROM TB_FEED_LIKE
			GROUP BY FEED_NO
		) LIKE_CNT ON F.FEED_NO = LIKE_CNT.FEED_NO
		LEFT JOIN (
			SELECT FEED_NO, COUNT(*) AS COMMENT_COUNT
			FROM TB_COMMENT
			WHERE IS_DELETED = 'N'
			GROUP BY FEED_NO
		) COMMENT_CNT ON F.FEED_NO = COMMENT_CNT.FEED_NO
		<if test="memberNo != null">
			LEFT JOIN TB_FEED_LIKE FL ON F.FEED_NO = FL.FEED_NO AND FL.MEMBER_NO = #{memberNo}
			LEFT JOIN TB_FEED_BOOKMARK FB ON F.FEED_NO = FB.FEED_NO AND FB.MEMBER_NO = #{memberNo}
		</if>
		WHERE F.FEED_NO = #{feedNo}
		AND F.IS_DELETED = 'N'
	</select>

	<!-- 피드 파일 목록 조회 -->
	<select id="selectFeedFileList" parameterType="_int" resultMap="feedFileResultMap">
		SELECT 
			FILE_NO,
			ORIGIN_NAME,
			SAVED_NAME,
			FILE_PATH,
			CREATED_AT,
			IS_DELETED,
			FEED_NO
		FROM TB_FEED_FILE
		WHERE FEED_NO = #{feedNo}
		AND (IS_DELETED = 'N' OR IS_DELETED IS NULL)
		ORDER BY FILE_ORDER, FILE_NO
	</select>

	<!-- 피드 생성 -->
	<insert id="insertFeed" parameterType="feed">
		<selectKey keyProperty="feedNo" resultType="_int" order="BEFORE">
			SELECT SEQ_FEED_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_FEED (
			FEED_NO,
			CONTENT,
			TAG,
			LATITUDE,
			LONGITUDE,
			LOCATION_NAME,
			CREATED_AT,
			IS_DELETED,
			MEMBER_NO
		) VALUES (
			#{feedNo},
			#{content},
			#{tag},
			#{latitude},
			#{longitude},
			#{locationName},
			SYSDATE,
			'N',
			#{memberNo}
		)
	</insert>

	<!-- 피드 파일 등록 -->
	<insert id="insertFeedFile" parameterType="feedFile">
		INSERT INTO TB_FEED_FILE (
			FILE_NO,
			FEED_NO,
			FILE_ORDER,
			ORIGIN_NAME,
			SAVED_NAME,
			FILE_PATH,
			FILE_TYPE,
			IS_DELETED,
			CREATED_AT
		) VALUES (
			SEQ_FILE_NO.NEXTVAL,
			#{feedNo},
			#{fileOrder},
			#{originName},
			#{savedName},
			#{filePath},
			#{fileType},
			'N',
			SYSDATE
		)
	</insert>

	<!-- 피드 좋아요 추가 -->
	<insert id="insertFeedLike" parameterType="hashmap">
		INSERT INTO TB_FEED_LIKE (
			FEED_NO,
			MEMBER_NO
		) VALUES (
			#{feedNo},
			#{memberNo}
		)
	</insert>

	<!-- 피드 좋아요 삭제 -->
	<delete id="deleteFeedLike" parameterType="hashmap">
		DELETE FROM TB_FEED_LIKE
		WHERE FEED_NO = #{feedNo}
		AND MEMBER_NO = #{memberNo}
	</delete>

	<!-- 피드 좋아요 여부 확인 -->
	<select id="checkFeedLike" parameterType="hashmap" resultType="_int">
		SELECT COUNT(*)
		FROM TB_FEED_LIKE
		WHERE FEED_NO = #{feedNo}
		AND MEMBER_NO = #{memberNo}
	</select>
	
	<!-- 피드 좋아요 개수 조회 -->
	<select id="selectFeedLikeCount" parameterType="_int" resultType="_int">
		SELECT NVL(COUNT(*), 0)
		FROM TB_FEED_LIKE
		WHERE FEED_NO = #{feedNo}
	</select>

	<!-- 피드 삭제 (IS_DEL = 'Y') -->
	<update id="deleteFeed" parameterType="_int">
		UPDATE TB_FEED
		SET IS_DELETED = 'Y', DELETED_AT = SYSDATE
		WHERE FEED_NO = #{feedNo}
	</update>
	
	<!-- 피드 수정 (내용/태그/위치) -->
	<update id="updateFeed" parameterType="feed">
		UPDATE TB_FEED
		SET
			CONTENT   = #{content},
			TAG       = #{tag},
			LATITUDE  = #{latitude},
			LONGITUDE = #{longitude},
			LOCATION_NAME = #{locationName}
		WHERE FEED_NO = #{feedNo}
		AND IS_DELETED = 'N'
	</update>

	<!-- 피드 북마크 추가 -->
	<insert id="insertFeedBookmark" parameterType="hashmap">
		INSERT INTO TB_FEED_BOOKMARK (
			BOOKMARK_NO,
			FEED_NO,
			MEMBER_NO
		) VALUES (
			SEQ_BOOKMARK_NO.NEXTVAL,
			#{feedNo},
			#{memberNo}
		)
	</insert>

	<!-- 피드 북마크 삭제 -->
	<delete id="deleteFeedBookmark" parameterType="hashmap">
		DELETE FROM TB_FEED_BOOKMARK
		WHERE FEED_NO = #{feedNo}
		AND MEMBER_NO = #{memberNo}
	</delete>

	<!-- 피드 북마크 여부 확인 -->
	<select id="checkFeedBookmark" parameterType="hashmap" resultType="_int">
		SELECT COUNT(*)
		FROM TB_FEED_BOOKMARK
		WHERE FEED_NO = #{feedNo}
		AND MEMBER_NO = #{memberNo}
	</select>

	<!-- 북마크한 피드 목록 조회 -->
	<select id="selectBookmarkedFeedList" parameterType="_int" resultMap="feedResultMap">
		SELECT 
			F.FEED_NO,
			F.CONTENT,
			F.TAG,
			F.LATITUDE,
			F.LONGITUDE,
			F.LOCATION_NAME,
			F.CREATED_AT,
			F.IS_DELETED,
			F.MEMBER_NO,
			M.MEMBER_NICK,
			NVL(LIKE_CNT.LIKE_COUNT, 0) AS LIKE_COUNT,
			NVL(COMMENT_CNT.COMMENT_COUNT, 0) AS COMMENT_COUNT,
			CASE WHEN FL.MEMBER_NO IS NOT NULL THEN 1 ELSE 0 END AS IS_LIKED,
			1 AS IS_BOOKMARKED
		FROM TB_FEED F
		INNER JOIN TB_FEED_BOOKMARK B ON F.FEED_NO = B.FEED_NO
		LEFT JOIN TB_MEMBER M ON F.MEMBER_NO = M.MEMBER_NO
		LEFT JOIN (
			SELECT FEED_NO, COUNT(*) AS LIKE_COUNT
			FROM TB_FEED_LIKE
			GROUP BY FEED_NO
		) LIKE_CNT ON F.FEED_NO = LIKE_CNT.FEED_NO
		LEFT JOIN (
			SELECT FEED_NO, COUNT(*) AS COMMENT_COUNT
			FROM TB_COMMENT
			WHERE IS_DELETED = 'N'
			GROUP BY FEED_NO
		) COMMENT_CNT ON F.FEED_NO = COMMENT_CNT.FEED_NO
		LEFT JOIN TB_FEED_LIKE FL ON F.FEED_NO = FL.FEED_NO AND FL.MEMBER_NO = #{value}
		WHERE B.MEMBER_NO = #{value}
		AND F.IS_DELETED = 'N'
		ORDER BY B.BOOKMARK_NO DESC
	</select>

	<!-- 내가 좋아요한 피드 목록 조회 -->
	<select id="selectLikedFeedList" parameterType="hashmap" resultMap="feedResultMap">
		SELECT 
			F.FEED_NO,
			F.CONTENT,
			F.TAG,
			F.LATITUDE,
			F.LONGITUDE,
			F.LOCATION_NAME,
			F.CREATED_AT,
			F.IS_DELETED,
			F.MEMBER_NO,
			M.MEMBER_NICK,
			(SELECT COUNT(*) FROM TB_FEED_LIKE WHERE FEED_NO = F.FEED_NO) AS LIKE_COUNT,
			(SELECT COUNT(*) FROM TB_COMMENT WHERE FEED_NO = F.FEED_NO AND IS_DELETED = 'N') AS COMMENT_COUNT,
			1 AS IS_LIKED,
			(SELECT PROFILE_SAVED_NAME FROM TB_MEMBER_HOME WHERE MEMBER_NO = F.MEMBER_NO) AS PROFILE_IMAGE
		FROM TB_FEED F
		JOIN TB_FEED_LIKE FL ON F.FEED_NO = FL.FEED_NO
		LEFT JOIN TB_MEMBER M ON F.MEMBER_NO = M.MEMBER_NO
		WHERE FL.MEMBER_NO = #{memberNo}
		AND F.IS_DELETED = 'N'
		<if test="startDate != null and startDate != ''">
			AND TO_CHAR(F.CREATED_AT, 'YYYY-MM-DD') &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND TO_CHAR(F.CREATED_AT, 'YYYY-MM-DD') &lt;= #{endDate}
		</if>
		<choose>
			<when test="sortBy == 'oldest'">
				ORDER BY F.CREATED_AT ASC
			</when>
			<otherwise>
				ORDER BY F.CREATED_AT DESC
			</otherwise>
		</choose>
	</select>

	<!-- 내가 댓글 단 목록 조회 (피드 이미지 포함) -->
	<select id="selectCommentedFeedList" parameterType="hashmap" resultType="comment">
		SELECT 
			C.COMMENT_NO AS commentNo,
			C.CONTENT AS content,
			C.CREATED_AT AS createdAt,
			C.FEED_NO AS feedNo,
			C.MEMBER_NO AS memberNo,
			M.MEMBER_NICK AS memberNick,
			MH.PROFILE_SAVED_NAME AS memberProfileImage,
			(SELECT CASE 
				WHEN FILE_PATH IS NULL THEN SAVED_NAME
				WHEN FILE_PATH LIKE '%/' THEN FILE_PATH || SAVED_NAME
				ELSE FILE_PATH || '/' || SAVED_NAME
			END
			FROM TB_FEED_FILE WHERE FEED_NO = F.FEED_NO AND IS_DELETED = 'N' AND ROWNUM = 1) AS feedImage
		FROM TB_COMMENT C
		JOIN TB_FEED F ON C.FEED_NO = F.FEED_NO
		JOIN TB_MEMBER M ON C.MEMBER_NO = M.MEMBER_NO
		LEFT JOIN TB_MEMBER_HOME MH ON M.MEMBER_NO = MH.MEMBER_NO
		WHERE C.MEMBER_NO = #{memberNo}
		AND C.IS_DELETED = 'N'
		AND F.IS_DELETED = 'N'
		<if test="startDate != null and startDate != ''">
			AND TO_CHAR(C.CREATED_AT, 'YYYY-MM-DD') &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND TO_CHAR(C.CREATED_AT, 'YYYY-MM-DD') &lt;= #{endDate}
		</if>
		<choose>
			<when test="sortBy == 'oldest'">
				ORDER BY C.CREATED_AT ASC
			</when>
			<otherwise>
				ORDER BY C.CREATED_AT DESC
			</otherwise>
		</choose>
	</select>

	<!-- ResultMap: Feed -->
	<resultMap type="feed" id="feedResultMap">
		<id property="feedNo" column="FEED_NO"/>
		<result property="content" column="CONTENT"/>
		<result property="tag" column="TAG"/>
		<result property="latitude" column="LATITUDE"/>
		<result property="longitude" column="LONGITUDE"/>
		<result property="createdAt" column="CREATED_AT"/>
		<result property="isDeleted" column="IS_DELETED"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="memberNick" column="MEMBER_NICK"/>
		<result property="memberStatus" column="MEMBER_STATUS"/>
		<result property="profileImage" column="PROFILE_IMAGE"/>
		<result property="likeCount" column="LIKE_COUNT"/>
		<result property="commentCount" column="COMMENT_COUNT"/>
		<result property="isLiked" column="IS_LIKED"/>
		<result property="isBookmarked" column="IS_BOOKMARKED"/>
		
		<!-- 지도(위치) 하나 추가 -->
		<result property="locationName" column="LOCATION_NAME"/>
		
		<!-- 피드 파일은 즉시 로딩하여 직렬화 시 프록시 문제 방지 -->
		<collection property="feedFiles" ofType="feedFile" select="selectFeedFileList" column="FEED_NO" fetchType="eager"/>
	</resultMap>

	<!-- ResultMap: FeedFile -->
	<resultMap type="feedFile" id="feedFileResultMap">
		<id property="fileNo" column="FILE_NO"/>
		<result property="fileOrder" column="FILE_ORDER"/>
		<result property="originName" column="ORIGIN_NAME"/>
		<result property="savedName" column="SAVED_NAME"/>
		<result property="filePath" column="FILE_PATH"/>
		<result property="fileType" column="FILE_TYPE"/>
		<result property="createdAt" column="CREATED_AT"/>
		<result property="isDeleted" column="IS_DELETED"/>
		<result property="feedNo" column="FEED_NO"/>
	</resultMap>

</mapper>

