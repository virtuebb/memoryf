<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="guestbookMapper">

    <!-- 방명록 목록 조회 -->
    <select id="selectGuestbookList"
            parameterType="map"
            resultType="guestbook">
        SELECT *
        FROM (
            SELECT
                G.GUESTBOOK_NO        AS guestbookNo,
                G.GUESTBOOK_CONTENT   AS guestbookContent,
                G.CREATE_DATE         AS createDate,
                G.IS_DEL              AS isDel,
                G.MEMBER_NO           AS memberNo,
                G.HOME_NO             AS homeNo,
                CASE WHEN (SELECT COUNT(*) 
                           FROM TB_STORY S 
                           WHERE S.MEMBER_NO = G.MEMBER_NO 
                             AND S.EXPIRE_DATE > SYSDATE) > 0 
                     THEN 1 ELSE 0 END AS "hasStory",
                CASE WHEN (SELECT COUNT(*) 
                           FROM TB_STORY S 
                           WHERE S.MEMBER_NO = G.MEMBER_NO 
                             AND S.EXPIRE_DATE > SYSDATE
                             AND NOT EXISTS (SELECT 1 FROM TB_STORY_VISITOR V WHERE V.STORY_NO = S.STORY_NO AND V.MEMBER_NO = #{currentMemberNo})) > 0 
                     THEN 1 ELSE 0 END AS "hasUnreadStory",
                ROWNUM AS rnum
            FROM (
                SELECT *
                FROM TB_GUESTBOOK G
                WHERE G.HOME_NO = #{homeNo}
                  AND G.IS_DEL = 'N'
                ORDER BY G.CREATE_DATE DESC
            ) G
            WHERE ROWNUM <![CDATA[<=]]> #{offset} + #{limit}
        )
        WHERE rnum > #{offset}
    </select>

    <!-- 방명록 등록 -->
    <insert id="insertGuestbook"
            parameterType="guestbook">
        INSERT INTO TB_GUESTBOOK (
            GUESTBOOK_NO,
            GUESTBOOK_CONTENT,
            MEMBER_NO,
            HOME_NO,
            CREATE_DATE,
            IS_DEL
        )
        VALUES (
            SEQ_GUESTBOOK_NO.NEXTVAL,
            #{guestbookContent},
            #{memberNo},
            #{homeNo},
            SYSDATE,
            'N'
        )
    </insert>

</mapper>
