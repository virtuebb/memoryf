<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WebSocket Chat</title>
<!-- ì´ ì›¹í˜ì´ì§€ëŠ” ì±„íŒ…ì„ í•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ì•¼. -->
<!-- SockJSì™€ STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ ì„œë²„ì™€ ì—°ê²°í•´. -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<h2>ì±„íŒ…</h2>
<!-- ì—¬ê¸°ì— ë‚´ ID, ë°›ëŠ” ì‚¬ëŒ ID, ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´. -->
<input id="myId" placeholder="ë‚´ ID (user1 / user2)">
<input id="targetId" placeholder="ë°›ëŠ” ì‚¬ëŒ ID">
<input id="msg" placeholder="ë©”ì‹œì§€">

<!-- ë²„íŠ¼ë“¤ë¡œ ì—°ê²°í•˜ê³ , ë©”ì‹œì§€ë¥¼ ë³´ë‚´. -->
<button id="connectBtn" onclick="connect()">ì—°ê²°</button>
<button id="disconnectBtn" onclick="disconnect()" disabled>ì—°ê²° í•´ì œ</button>
<button onclick="sendPrivate()">1:1 ë³´ë‚´ê¸°</button>

<!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸° ë‚˜íƒ€ë‚˜. -->
<ul id="chat"></ul>

<script>
    let stompClient = null; // ì„œë²„ì™€ ì—°ê²°í•˜ëŠ” ë„êµ¬
    let myId = ""; // ë‚´ ID ì €ì¥
    let isConnected = false; // ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸

    // ì´ í•¨ìˆ˜ëŠ” ì„œë²„ì— ì—°ê²°í•˜ëŠ” í•¨ìˆ˜ì•¼.
    function connect() {

        // âœ… ì´ë¯¸ ì—°ê²°ë¼ ìˆìœ¼ë©´ ë¬´ì‹œ
        if (isConnected) {
            alert("ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        myId = document.getElementById("myId").value;

        if (!myId) {
            alert("ë‚´ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        // SockJSë¡œ ì„œë²„ì— ì—°ê²°í•´.
        const socket = new SockJS("/memoryf/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {

            isConnected = true; // ğŸ”¥ ì—°ê²° ì™„ë£Œ
            document.getElementById("connectBtn").disabled = true;
            document.getElementById("disconnectBtn").disabled = false;

            addMessage("[" + myId + "] ì—°ê²° ì„±ê³µ");

            // ë‚´ê²Œ ì˜¤ëŠ” ë©”ì‹œì§€ë¥¼ ë“£ëŠ” ê³³
            stompClient.subscribe("/sub/private/" + myId, function (msg) {
                const data = JSON.parse(msg.body);
                addMessage(data.sender + " â†’ ë‚˜ : " + data.content);
            });
        });
    }

    // ì´ í•¨ìˆ˜ëŠ” ì—°ê²°ì„ ëŠëŠ” í•¨ìˆ˜ì•¼.
    function disconnect() {
        if (stompClient && isConnected) {
            stompClient.disconnect();
            isConnected = false;
            document.getElementById("connectBtn").disabled = false;
            document.getElementById("disconnectBtn").disabled = true;
            addMessage("ì—°ê²° í•´ì œë¨");
        }
    }

    // ì´ í•¨ìˆ˜ëŠ” 1:1 ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” í•¨ìˆ˜ì•¼.
    function sendPrivate() {
        stompClient.send("/pub/chat/private", {}, JSON.stringify({
            roomId: document.getElementById("targetId").value, // ë°›ëŠ” ì‚¬ëŒ
            sender: myId,
            content: document.getElementById("msg").value
        }));
    }

    // ì´ í•¨ìˆ˜ëŠ” ì±„íŒ… ëª©ë¡ì— ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ì•¼.
    function addMessage(text) {
        const li = document.createElement("li");
        li.innerText = text;
        document.getElementById("chat").appendChild(li);
    }
</script>


</body>
</html>
