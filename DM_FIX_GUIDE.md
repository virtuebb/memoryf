# DM ì‹¤ì‹œê°„ ê¸°ëŠ¥ ìµœì¢… ìˆ˜ì • ê°€ì´ë“œ

## ë¬¸ì œì  ë¶„ì„

### 1ï¸âƒ£ ì½ìŒì²˜ë¦¬ í›„ ë°°ì§€(1)ê°€ ì•ˆ ì‚¬ë¼ì§
**ì›ì¸**: `handleMarkAsRead` í•¨ìˆ˜ì—ì„œ REST API í˜¸ì¶œì„ ê¸°ë‹¤ë¦° í›„ì— UIë¥¼ ì—…ë°ì´íŠ¸
**í•´ê²°**: UI ì—…ë°ì´íŠ¸ë¥¼ **ë¨¼ì €** ì‹¤í–‰, DB ì €ì¥ì€ **ë°±ê·¸ë¼ìš´ë“œ**ì—ì„œ

### 2ï¸âƒ£ ìƒˆ ë©”ì‹œì§€ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì±„íŒ…ëª©ë¡ì— í‘œì‹œ ì•ˆ ë¨
**ì›ì¸**: `handleReceiveMessage`ì—ì„œ ë©”ì‹œì§€ëŠ” ì¶”ê°€í•˜ì§€ë§Œ `lastMessage`, `time` ì—…ë°ì´íŠ¸ ëˆ„ë½
**í•´ê²°**: ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì´ ë‘ í•„ë“œë„ ë™ì‹œ ì—…ë°ì´íŠ¸

### 3ï¸âƒ£ ìƒˆë¡œê³ ì¹¨í•´ì•¼ ë©”ì‹œì§€ê°€ ë³´ì„
**ì›ì¸**: WebSocket `@MessageMapping("/chat/private")`ì´ ì •ìƒ ì‘ë™í•˜ì§€ ì•Šê±°ë‚˜ JSON í•„ë“œëª… ë¶ˆì¼ì¹˜
**í•´ê²°**: ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸ + í•„ë“œëª… ì¼ì¹˜ í™•ì¸

---

## ìˆ˜ì •ì‚¬í•­

### í”„ë¡ íŠ¸ì—”ë“œ (DmContext.jsx)

#### Step 1: handleMarkAsRead ìˆ˜ì • (ë¼ì¸ ~364)

```javascript
// ì´ì „ ì½”ë“œ: DB ì €ì¥ì„ ë¨¼ì € í•˜ê³  UI ì—…ë°ì´íŠ¸
if (chat.id) {
  markMessageAsRead(chat.id, myUserId)
    .then(response => {
      console.log('DB save:', response);
    });
}

// ìˆ˜ì • ì½”ë“œ: UIë¥¼ ë¨¼ì € ì—…ë°ì´íŠ¸
// Step 1: UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ìê°€ ë°”ë¡œ ëŠë‚„ ìˆ˜ ìˆìŒ)
setChatRooms(p => p.map(r => String(r.id) === String(chatId) ? {...r, unread: 0} : r));
setPendingChats(p => p.map(r => String(r.id) === String(chatId) ? {...r, unread: 0} : r));

// Step 2: DBì— ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ, ì•ˆ ê¸°ë‹¤ë¦¼)
if (chat.id) {
  markMessageAsRead(chat.id, myUserId).catch(e => console.error('DB error:', e));
}
```

#### Step 2: handleReceiveMessage ìˆ˜ì • (ë¼ì¸ ~230)

```javascript
// ì´ì „: lastMessage, timeì„ ë°©ê¸ˆìœ¼ë¡œ ì„¤ì •ë§Œ í•¨
lastMessage: content,
time: 'ë°©ê¸ˆ',

// ìˆ˜ì •: ì‹¤ì œ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
lastMessage: content,
time: new Date().toLocaleTimeString('ko-KR', { 
  hour: '2-digit', 
  minute: '2-digit', 
  hour12: true 
}),
```

---

## ë°±ì—”ë“œ í™•ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

âœ… **DmController.java**
- `@MessageMapping("/chat/private")` ë©”ì„œë“œ í™•ì¸
- ë©”ì‹œì§€ ì €ì¥ ë¡œê·¸ ì¶œë ¥ í™•ì¸: `âœ… ë©”ì‹œì§€ DB ì €ì¥ ì™„ë£Œ`
- WebSocket ì „ì†¡ ë¡œê·¸: `ğŸ“¤ /sub/private/ + recipientë¡œ ë©”ì‹œì§€ ì „ì†¡`

âœ… **í•„ë“œëª… ì¼ì¹˜ í™•ì¸**
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚´ëŠ” í•„ë“œ:
  - `type`, `roomNo`, `roomId`, `sender`, `content`
- ë°±ì—”ë“œ Dm.java ê°ì²´ í•„ë“œ:
  - `sender` (ë˜ëŠ” `senderId`)
  - `roomNo`, `roomId`
  - `content`

---

## ì½˜ì†” ë¡œê·¸ í™•ì¸ ë°©ë²•

### í”„ë¡ íŠ¸ì—”ë“œ (ë¸Œë¼ìš°ì € ê°œë°œìë„êµ¬ - F12)

```
ë©”ì‹œì§€ ì „ì†¡:
ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: user1 â†’ user2 (roomNo:1): ì•ˆë…•í•˜ì„¸ìš”

ë©”ì‹œì§€ ìˆ˜ì‹ :
ğŸ“© /sub ë©”ì‹œì§€ ìˆ˜ì‹ : {type: 'message', roomNo: 1, ...}

ì½ìŒ ì²˜ë¦¬:
ğŸ‘ï¸ í˜„ì¬ ë³´ëŠ” ì±„íŒ…ë°© ì„¤ì •: user2
UI update - unread to 0 for room 1
ğŸ‘€ ì½ìŒ ì´ë²¤íŠ¸ ì „ì†¡: user1 â†’ user2
```

### ë°±ì—”ë“œ (í„°ë¯¸ë„)

```
ë©”ì‹œì§€ ì €ì¥:
ğŸ“¨ ë©”ì‹œì§€ ì €ì¥ ìš”ì²­ ìˆ˜ì‹ 
roomNo : 1
senderId : user1
content : ì•ˆë…•í•˜ì„¸ìš”
âœ… ë©”ì‹œì§€ ì €ì¥ ì™„ë£Œ - ê²°ê³¼: 1

WebSocket ì „ì†¡:
â¡ï¸ ëŒ€ìƒ(recipient): user2 , roomNo: 1
âœ… ë©”ì‹œì§€ DB ì €ì¥ ì™„ë£Œ
ğŸ“¤ /sub/private/user2ë¡œ ë©”ì‹œì§€ ì „ì†¡
```

---

## í…ŒìŠ¤íŠ¸ ìˆœì„œ

1. **ì½ìŒì²˜ë¦¬ ë°°ì§€ í…ŒìŠ¤íŠ¸**
   - ë‘ íƒ­ì—ì„œ ê°ê° ë¡œê·¸ì¸
   - íƒ­1ì—ì„œ íƒ­2ë¡œ ë©”ì‹œì§€ ë°œì†¡
   - íƒ­2ì˜ ì±„íŒ…ëª©ë¡ì— ë¹¨ê°„ 1 í‘œì‹œ í™•ì¸
   - íƒ­2ì—ì„œ ì±„íŒ…ë°© ì…ì¥
   - íƒ­2ì˜ 1ì´ ì‚¬ë¼ì§€ëŠ”ì§€ í™•ì¸ (ì¦‰ì‹œ!)

2. **ì‹¤ì‹œê°„ ë©”ì‹œì§€ í‘œì‹œ í…ŒìŠ¤íŠ¸**
   - íƒ­1ì—ì„œ íƒ­2ë¡œ ë©”ì‹œì§€ ë°œì†¡
   - íƒ­2ì˜ ì±„íŒ…ëª©ë¡ì—ì„œ lastMessage ì—…ë°ì´íŠ¸ í™•ì¸
   - ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸ í™•ì¸

3. **ìƒˆë¡œê³ ì¹¨ í•„ìš” ì—¬ë¶€ í…ŒìŠ¤íŠ¸**
   - ëª¨ë“  ê¸°ëŠ¥ì´ ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸
